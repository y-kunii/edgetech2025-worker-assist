# Task 14.1 実装サマリー: ラズパイ実機テスト

## 実装日
2025年10月14日

## タスク概要
ラズパイ実機でのパフォーマンステストを実施するためのテストスクリプトとドキュメントを作成しました。

## 要件
- **要件 8.1**: メモリ使用量を512MB以下に抑える
- **要件 8.2**: CPU使用率を50%以下に抑える

## 実装内容

### 1. パフォーマンステストスクリプト (`scripts/raspi-performance-test.js`)

#### 主要機能
- **サーバー起動時間の測定**: WebSocketサーバーの起動にかかる時間を計測
- **メモリ使用量の監視**: 1秒ごとにメモリ使用量をサンプリング（60秒間）
- **CPU使用率の監視**: 1秒ごとにCPU使用率をサンプリング（60秒間）
- **統計レポート生成**: 最小値、最大値、平均値、中央値を計算
- **合否判定**: 要件に基づいた自動判定

#### テストフロー
1. サーバーを起動し、起動時間を測定
2. 3秒間の安定化待機
3. 60秒間のパフォーマンス監視（1秒ごとにサンプリング）
4. 統計情報の計算とレポート生成
5. サーバーの優雅なシャットダウン

#### 判定基準
- **メモリ**: 最大メモリ使用量が512MB以下で PASS
- **CPU**: 平均CPU使用率が50%以下で PASS
- **総合**: メモリとCPUの両方がPASSで総合PASS

### 2. ドキュメント (`docs/RASPI_PERFORMANCE_TEST.md`)

#### 内容
- テストの概要と目的
- 前提条件と実行方法
- テストの流れの詳細説明
- 出力例とレポートの見方
- 合否判定基準
- トラブルシューティングガイド
- 監視期間のカスタマイズ方法
- 負荷テストとの組み合わせ方法
- CI/CDへの統合例

### 3. package.json への追加

新しいnpmスクリプトを追加：
```json
"test:performance": "node scripts/raspi-performance-test.js"
```

### 4. README の更新

メインREADMEにパフォーマンステストのセクションを追加し、使用方法を記載。

## 使用方法

### 基本的な実行
```bash
npm run test:performance
```

### ラズパイでの実行
```bash
# 1. ビルド
npm run build

# 2. テスト実行
npm run test:performance
```

## 出力例

```
🔍 Raspberry Pi Performance Test
============================================================
Memory Threshold: 512 MB
CPU Threshold: 50%
Monitoring Duration: 60s
============================================================

🚀 Starting WebSocket server...
✅ Server started in 1234ms (PID: 12345)

📊 Monitoring performance for 60 seconds...
Time(s)	Memory(MB)	CPU(%)
-------	----------	------
0	45.23		12.50
1	46.12		15.30
...

============================================================
📋 PERFORMANCE TEST REPORT
============================================================

🚀 Startup Time:
   1234ms

💾 Memory Usage:
   Minimum:  45.23 MB
   Maximum:  52.34 MB
   Average:  48.56 MB
   Median:   48.12 MB
   Threshold: 512 MB
   Status:   ✅ PASS

⚡ CPU Usage:
   Minimum:  8.50%
   Maximum:  25.30%
   Average:  15.67%
   Median:   14.80%
   Threshold: 50%
   Status:   ✅ PASS

============================================================
Overall Result: ✅ PASS
============================================================
```

## 技術的な詳細

### 使用技術
- **Node.js child_process**: サーバープロセスの起動と管理
- **psコマンド**: メモリとCPU使用率の取得
- **Promise/async-await**: 非同期処理の制御

### メトリクス取得方法
- **メモリ**: `ps -p <pid> -o rss=` でRSS（Resident Set Size）を取得し、MBに変換
- **CPU**: `ps -p <pid> -o %cpu=` でCPU使用率を取得
- **起動時間**: サーバー起動開始から起動完了ログ出力までの時間を計測

### エラーハンドリング
- サーバー起動失敗時の適切なエラーメッセージ
- プロセス監視エラー時の継続処理
- タイムアウト処理（30秒）
- シグナルハンドリング（SIGINT、SIGTERM）

## 検証項目

### ✅ 実装完了項目
- [x] メモリ使用量の測定機能
- [x] CPU使用率の測定機能
- [x] 起動時間の測定機能
- [x] 統計情報の計算（最小、最大、平均、中央値）
- [x] 合否判定ロジック
- [x] レポート生成機能
- [x] エラーハンドリング
- [x] 優雅なシャットダウン
- [x] ドキュメント作成
- [x] README更新
- [x] npmスクリプト追加

### 📝 テスト項目
- [x] スクリプトの構文チェック（`node -c`）
- [x] ビルドファイルの存在確認
- [ ] ラズパイ実機での実行（要実機環境）

## 今後の拡張可能性

### 追加可能な機能
1. **負荷テスト統合**: 複数クライアント接続時のパフォーマンス測定
2. **長時間テスト**: 24時間運用テストの自動化
3. **メトリクスのエクスポート**: JSON/CSV形式でのデータ出力
4. **グラフ生成**: パフォーマンスデータの可視化
5. **アラート機能**: 閾値超過時の通知
6. **比較機能**: 過去のテスト結果との比較

### CI/CD統合
- GitHub Actionsでのセルフホストランナー設定
- 定期的な自動テスト実行
- パフォーマンス劣化の検出

## 関連ファイル

### 新規作成
- `scripts/raspi-performance-test.js` - パフォーマンステストスクリプト
- `docs/RASPI_PERFORMANCE_TEST.md` - テストドキュメント
- `docs/TASK_14.1_SUMMARY.md` - このサマリー

### 更新
- `package.json` - test:performanceスクリプト追加
- `raspberry-pi-websocket-server-README.md` - パフォーマンステストセクション追加

## 参照
- 要件定義書: `.kiro/specs/raspberry-pi-websocket-server/requirements.md` (要件8.1, 8.2)
- 設計書: `.kiro/specs/raspberry-pi-websocket-server/design.md` (パフォーマンス最適化セクション)
- タスクリスト: `.kiro/specs/raspberry-pi-websocket-server/tasks.md` (タスク14.1)

## 注意事項

### 実行環境
- このテストは**ラズパイ実機**での実行を想定しています
- 開発マシン（Mac/Windows）でも実行可能ですが、結果は参考値となります
- `ps`コマンドが利用可能な環境が必要です

### 測定精度
- CPU使用率は瞬間値のため、負荷によって変動します
- より正確な測定には、負荷をかけた状態でのテストが推奨されます
- 初回起動時はNode.jsのJITコンパイルにより、CPU使用率が高くなる可能性があります

### 推奨事項
1. テスト実行前に他のプロセスを停止し、システムリソースを確保
2. 複数回テストを実行し、平均値を取得
3. 負荷テストと組み合わせて、実運用に近い状態で測定

## まとめ

タスク14.1「ラズパイ実機テストを実施」のための包括的なテストスクリプトとドキュメントを実装しました。このスクリプトにより、要件8.1（メモリ使用量512MB以下）と要件8.2（CPU使用率50%以下）を自動的に検証できます。

実機での実行により、WebSocketサーバーがラズパイの限られたリソースで効率的に動作することを確認できます。
