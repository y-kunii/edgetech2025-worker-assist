# 実装タスクリスト

- [x] 1. プロジェクト構造とセットアップ
  - プロジェクトディレクトリ構造を作成
  - package.jsonとtsconfig.jsonを作成
  - 必要な依存パッケージをインストール
  - _要件: 6.1, 6.2_

- [x] 2. 型定義の実装
  - [x] 2.1 基本型定義を作成
    - src/types/index.tsファイルを作成
    - ServerConfig、ClientType、LogLevel型を定義
    - _要件: 6.3_
  
  - [x] 2.2 データモデル型を定義
    - SensorData、RobotCommand、RobotResponse型を定義
    - HealthStatus、ConnectionStats、ErrorInfo型を定義
    - _要件: 2.2, 4.2, 5.2_

- [x] 3. 設定マネージャーの実装
  - [x] 3.1 ConfigManagerクラスを作成
    - src/utils/ConfigManager.tsファイルを作成
    - デフォルト設定を定義
    - _要件: 6.1, 6.2_
  
  - [x] 3.2 設定ファイル読み込み機能を実装
    - config.jsonファイルの読み込み処理を実装
    - 設定の検証機能を実装
    - エラー時のデフォルト設定使用を実装
    - _要件: 6.2, 6.4_
  
  - [x] 3.3 ConfigManagerの単体テストを作成
    - 設定読み込みのテスト
    - デフォルト設定のテスト
    - 不正な設定ファイルのテスト
    - _要件: 6.2, 6.4_

- [x] 4. ロガーの実装
  - [x] 4.1 Loggerクラスを作成
    - src/utils/Logger.tsファイルを作成
    - winstonを使用したロガーを実装
    - ログレベル別のメソッド（debug, info, warn, error）を実装
    - _要件: 7.1, 7.2_
  
  - [x] 4.2 ログファイルローテーション機能を実装
    - winston-daily-rotate-fileを使用
    - ログディレクトリの自動作成を実装
    - _要件: 7.4, 7.5_
  
  - [x] 4.3 Loggerの単体テストを作成
    - 各ログレベルのテスト
    - ログファイル出力のテスト
    - _要件: 7.1, 7.2, 7.3_

- [x] 5. 接続マネージャーの実装
  - [x] 5.1 ConnectionManagerクラスを作成
    - src/server/ConnectionManager.tsファイルを作成
    - クライアント登録・登録解除機能を実装
    - _要件: 1.2, 3.1_
  
  - [x] 5.2 クライアントタイプ別管理機能を実装
    - タイプ別クライアント取得メソッドを実装
    - センサー/ロボットクライアントの単一接続管理を実装
    - 重複接続時の既存接続切断を実装
    - _要件: 3.2, 3.3, 3.4, 3.5_
  
  - [x] 5.3 接続統計機能を実装
    - getConnectionStatsメソッドを実装
    - isClientConnectedメソッドを実装
    - _要件: 5.2_
  
  - [x] 5.4 ConnectionManagerの単体テストを作成
    - クライアント登録のテスト
    - タイプ別取得のテスト
    - 重複接続処理のテスト
    - 接続統計のテスト
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 6. メッセージルーターの実装
  - [x] 6.1 MessageRouterクラスを作成
    - src/server/MessageRouter.tsファイルを作成
    - ConnectionManagerとLoggerへの依存を設定
    - _要件: 2.1, 4.1_
  
  - [x] 6.2 センサーデータルーティングを実装
    - routeSensorDataメソッドを実装
    - Electronクライアントへのデータ転送を実装
    - センサープログラム未接続時のエラー処理を実装
    - _要件: 2.1, 2.2, 2.3, 2.4_
  
  - [x] 6.3 ロボット指示ルーティングを実装
    - routeRobotCommandメソッドを実装
    - ロボット制御プログラムへの指示転送を実装
    - ロボットプログラム未接続時のエラー応答を実装
    - _要件: 4.1, 4.2, 4.5, 4.6_
  
  - [x] 6.4 ロボット応答ルーティングを実装
    - routeRobotResponseメソッドを実装
    - Electronクライアントへの応答転送を実装
    - _要件: 4.3, 4.4_
  
  - [x] 6.5 エラー応答機能を実装
    - sendErrorResponseメソッドを実装
    - エラーコード定義を実装
    - _要件: 2.5, 4.6, 9.3_
  
  - [x] 6.6 MessageRouterの単体テストを作成
    - センサーデータルーティングのテスト
    - ロボット指示ルーティングのテスト
    - ロボット応答ルーティングのテスト
    - エラー処理のテスト
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 7. ハートビートマネージャーの実装
  - [x] 7.1 HeartbeatManagerクラスを作成
    - src/server/HeartbeatManager.tsファイルを作成
    - ハートビート送信機能を実装
    - _要件: 1.3_
  
  - [x] 7.2 タイムアウト検出機能を実装
    - 最終pong時刻の記録を実装
    - タイムアウトチェック機能を実装
    - タイムアウト時の接続切断を実装
    - _要件: 9.6_
  
  - [x] 7.3 HeartbeatManagerの単体テストを作成
    - ハートビート送信のテスト
    - pong受信処理のテスト
    - タイムアウト検出のテスト
    - _要件: 1.3, 9.6_

- [x] 8. メインサーバーの実装
  - [x] 8.1 MainServerクラスの基本構造を作成
    - src/server/MainServer.tsファイルを作成
    - Expressアプリとhttpサーバーを初期化
    - Socket.ioサーバーを初期化
    - 各マネージャーのインスタンスを作成
    - _要件: 1.1, 1.2_
  
  - [x] 8.2 WebSocket接続処理を実装
    - connection イベントハンドラーを実装
    - register_client イベントハンドラーを実装
    - クライアントタイプの識別と登録を実装
    - _要件: 1.2, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  
  - [x] 8.3 WebSocket切断処理を実装
    - disconnect イベントハンドラーを実装
    - リソース解放処理を実装
    - Electronクライアントへの切断通知を実装
    - _要件: 1.3, 3.7, 9.2_
  
  - [x] 8.4 イベントハンドラーを実装
    - sensor_data イベントハンドラーを実装
    - robot_command イベントハンドラーを実装
    - robot_response イベントハンドラーを実装
    - pong イベントハンドラーを実装
    - _要件: 2.1, 4.1, 4.3_
  
  - [x] 8.5 HTTPヘルスチェックAPIを実装
    - /health エンドポイントを実装
    - HealthStatus生成機能を実装
    - _要件: 5.1, 5.2, 5.3, 5.4_
  
  - [x] 8.6 サーバー起動・停止機能を実装
    - startメソッドを実装
    - stopメソッドを実装
    - 優雅なシャットダウン処理を実装
    - _要件: 10.1, 10.2, 10.3, 10.4_
  
  - [x] 8.7 エラーハンドリングを実装
    - グローバルエラーハンドラーを実装
    - 予期しないエラーの処理を実装
    - 致命的エラー時のシャットダウンを実装
    - _要件: 9.1, 9.3, 9.4, 9.5_

- [x] 9. エントリーポイントの実装
  - [x] 9.1 index.tsを作成
    - src/index.tsファイルを作成
    - 設定の読み込みを実装
    - MainServerのインスタンス化と起動を実装
    - _要件: 10.1, 10.2_
  
  - [x] 9.2 シグナルハンドリングを実装
    - SIGTERM/SIGINTハンドラーを実装
    - 優雅なシャットダウンを実装
    - _要件: 10.3, 10.4_

- [x] 10. 統合テストの作成
  - [x] 10.1 基本接続テストを作成
    - 各タイプのクライアント接続テスト
    - クライアントタイプ識別テスト
    - _要件: 1.2, 3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [x] 10.2 データ中継テストを作成
    - センサーデータ転送テスト
    - ロボット指示転送テスト
    - ロボット応答転送テスト
    - _要件: 2.1, 2.2, 2.3, 4.1, 4.2, 4.3, 4.4_
  
  - [x] 10.3 エラーハンドリングテストを作成
    - 外部プログラム未接続時のテスト
    - 不正データ形式のテスト
    - 接続タイムアウトのテスト
    - _要件: 2.4, 2.5, 4.5, 4.6, 9.1, 9.2, 9.3, 9.6_
  
  - [x] 10.4 ハートビートテストを作成
    - ハートビート送信テスト
    - タイムアウト検出テスト
    - _要件: 1.3, 9.6_
  
  - [x] 10.5 ヘルスチェックテストを作成
    - ヘルスチェックAPI応答テスト
    - 接続状態報告テスト
    - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 11. 設定ファイルとドキュメントの作成
  - [x] 11.1 デフォルト設定ファイルを作成
    - config/config.jsonを作成
    - デフォルト値を設定
    - _要件: 6.1, 6.2_
  
  - [x] 11.2 READMEを作成
    - インストール手順を記載
    - 起動方法を記載
    - 設定方法を記載
    - トラブルシューティングを記載
    - _要件: 10.1, 10.2_
  
  - [x] 11.3 systemdサービスファイルを作成
    - raspberry-pi-websocket-server.serviceを作成
    - サービス設定を記載
    - _要件: 10.5_

- [x] 12. ビルドとデプロイの準備
  - [x] 12.1 ビルドスクリプトを作成
    - package.jsonにbuildスクリプトを追加
    - TypeScriptコンパイル設定を確認
    - _要件: 10.1_
  
  - [x] 12.2 デプロイスクリプトを作成
    - ラズパイへの転送スクリプトを作成
    - セットアップスクリプトを作成
    - _要件: 10.1, 10.5_

- [x] 13. パフォーマンス最適化
  - [x] 13.1 メモリ使用量の最適化
    - オブジェクトプールの実装
    - 不要なデータコピーの削減
    - _要件: 8.1, 8.3_
  
  - [x] 13.2 メモリ監視機能を実装
    - メモリ使用量チェック機能を実装
    - 閾値超過時の警告ログを実装
    - _要件: 8.4_
  
  - [x] 13.3 非同期処理の最適化
    - すべてのI/O操作を非同期化
    - イベントループのブロッキング回避を確認
    - _要件: 8.2_

- [ ] 14. 最終テストと検証
  - [x] 14.1 ラズパイ実機テストを実施
    - メモリ使用量の確認（512MB以下）
    - CPU使用率の確認（50%以下）
    - 起動時間の確認
    - _要件: 8.1, 8.2_
  
  - [ ] 14.2 長時間運用テストを実施
    - 24時間運用テスト
    - メモリリークの確認
    - _要件: 8.5_
  
  - [x] 14.3 負荷テストを実施
    - 複数クライアント同時接続テスト（10クライアント）
    - 高頻度データ送信テスト（1秒間に10メッセージ）
    - _要件: 1.4_
  
  - [x] 14.4 systemdサービステストを実施
    - サービス起動テスト
    - 自動起動テスト
    - サービス再起動テスト
    - _要件: 10.5_
