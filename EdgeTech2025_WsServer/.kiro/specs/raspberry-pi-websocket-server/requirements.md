# 要件定義書

## はじめに

製造現場デジタルツインシステムのために、ラズパイ上で動作するWebSocketサーバーを構築します。このサーバーは、Electronクライアントアプリケーションと外部センサー/カメラプログラム間のデータ中継を担当します。センサーデータの収集やカメラ映像の取得は別プログラムで実施され、本サーバーはそれらのデータをクライアントに転送し、クライアントからのロボット制御指示を外部プログラムに転送します。

## 要件

### 要件1: WebSocket通信機能

**ユーザーストーリー:** システム管理者として、Electronクライアントとラズパイサーバー間でリアルタイム双方向通信を確立したい。これにより、センサーデータの送信とロボット制御指示の受信が可能になる。

#### 受入基準

1. WHEN ラズパイサーバーが起動した THEN サーバーはポート3001でWebSocket接続を待ち受ける SHALL
2. WHEN Electronクライアントが接続要求を送信した THEN サーバーは接続を受け入れ、接続確認メッセージを送信する SHALL
3. WHEN クライアントが切断した THEN サーバーは適切にリソースを解放し、再接続を受け入れる準備をする SHALL
4. WHEN 複数のクライアントが接続した THEN サーバーは各クライアントを独立して管理する SHALL
5. IF 接続エラーが発生した THEN サーバーはエラーログを記録し、接続を適切にクローズする SHALL

### 要件2: センサーデータの中継

**ユーザーストーリー:** 製造現場の監視者として、作業者の状態、ロボットの状態、作業進捗をリアルタイムで確認したい。これにより、現場の状況を即座に把握できる。

#### 受入基準

1. WHEN 外部プログラムから`sensor_data`イベントを受信した THEN サーバーは接続中の全Electronクライアントにデータを転送する SHALL
2. WHEN センサーデータを転送する THEN 以下の情報を含む SHALL:
   - `worker_status`: 作業者状態（waiting, screw_tightening, bolt_tightening, tool_handover, absent）
   - `robot_status`: ロボット状態（state: waiting/operating, grip: open/closed）
   - `screw_count`: ネジ締め回数
   - `bolt_count`: ボルト締め回数
   - `work_step`: 現在の作業ステップ
   - `image`: Base64エンコードされたカメラ画像（オプション）
3. WHEN データを転送する THEN データの内容を変更せず、そのまま転送する SHALL
4. IF 外部プログラムが接続していない場合 THEN サーバーは警告ログを記録し、Electronクライアントにエラー通知を送信する SHALL
5. IF データ転送に失敗した THEN サーバーはエラーログを記録し、該当クライアントの接続状態を確認する SHALL

### 要件3: 外部プログラムとの接続管理

**ユーザーストーリー:** システム管理者として、センサー/カメラプログラムとロボット制御プログラムをWebSocketサーバーに接続したい。これにより、データの送受信が可能になる。

#### 受入基準

1. WHEN 外部プログラムが接続した THEN サーバーはクライアントタイプ（sensor, robot, electron）を識別する SHALL
2. WHEN クライアントが接続する THEN 接続時に`client_type`パラメータを送信する SHALL
3. WHEN センサープログラムが接続した THEN サーバーは`sensor`タイプとして登録し、接続ログを記録する SHALL
4. WHEN ロボット制御プログラムが接続した THEN サーバーは`robot`タイプとして登録し、接続ログを記録する SHALL
5. WHEN Electronクライアントが接続した THEN サーバーは`electron`タイプとして登録し、接続ログを記録する SHALL
6. IF クライアントタイプが指定されていない場合 THEN デフォルトで`unknown`タイプとして扱う SHALL
7. WHEN 外部プログラムが切断した THEN サーバーは警告ログを記録し、Electronクライアントに通知を送信する SHALL

### 要件4: ロボット制御指示の中継

**ユーザーストーリー:** 製造現場の作業者として、Electronアプリからロボットに指示を送信したい。これにより、ロボットの動作を制御できる。

#### 受入基準

1. WHEN Electronクライアントから`robot_command`イベントを受信した THEN サーバーはコマンドをログに記録し、ロボット制御プログラムに転送する SHALL
2. WHEN ロボット指示を転送する THEN 以下のコマンドタイプをサポートする SHALL:
   - `tool_handover`: 工具受け渡し
   - `next_task`: 次タスクへ移行
   - `emergency_stop`: 緊急停止
   - `reset`: リセット
3. WHEN ロボット制御プログラムから`robot_response`イベントを受信した THEN サーバーは元のElectronクライアントに応答を転送する SHALL
4. WHEN 応答を転送する THEN 以下の情報を含む SHALL:
   - `command`: 実行したコマンド
   - `status`: 実行結果（success, error, emergency_stopped）
   - `timestamp`: タイムスタンプ
5. IF ロボット制御プログラムが接続していない場合 THEN サーバーはElectronクライアントにエラー応答を返す SHALL
6. IF コマンド転送に失敗した THEN サーバーはエラーログを記録し、Electronクライアントにエラー応答を返す SHALL

### 要件5: HTTPヘルスチェックAPI

**ユーザーストーリー:** システム管理者として、サーバーの稼働状態を確認したい。これにより、システムの健全性を監視できる。

#### 受入基準

1. WHEN `/health`エンドポイントにGETリクエストが送信された THEN サーバーは稼働状態をJSON形式で返す SHALL
2. WHEN ヘルスチェック応答を返す THEN 以下の情報を含む SHALL:
   - `status`: サーバー状態（ok, error）
   - `timestamp`: 現在時刻
   - `connections`: 接続中のクライアント数（タイプ別）
   - `sensor_connected`: センサープログラムの接続状態（true/false）
   - `robot_connected`: ロボット制御プログラムの接続状態（true/false）
3. IF サーバーが正常に動作している THEN HTTPステータスコード200を返す SHALL
4. IF サーバーにエラーがある THEN HTTPステータスコード503を返す SHALL

### 要件6: 設定管理

**ユーザーストーリー:** システム管理者として、サーバーの動作パラメータを設定ファイルで管理したい。これにより、環境に応じた柔軟な設定が可能になる。

#### 受入基準

1. WHEN サーバーが起動した THEN `config.json`ファイルから設定を読み込む SHALL
2. WHEN 設定ファイルが存在しない THEN デフォルト設定を使用し、警告ログを記録する SHALL
3. WHEN 設定を読み込む THEN 以下のパラメータをサポートする SHALL:
   - `port`: WebSocketサーバーのポート番号（デフォルト: 3001）
   - `cors_origin`: CORS許可オリジン（デフォルト: "*"）
   - `heartbeat_interval`: ハートビート送信間隔（ミリ秒、デフォルト: 30000）
   - `connection_timeout`: 接続タイムアウト（ミリ秒、デフォルト: 60000）
   - `log_level`: ログレベル（debug, info, warn, error、デフォルト: info）
   - `log_file`: ログファイルパス（デフォルト: logs/server.log）
4. IF 設定ファイルの形式が不正な場合 THEN サーバーはエラーログを記録し、デフォルト設定を使用する SHALL

### 要件7: ログ記録

**ユーザーストーリー:** システム管理者として、サーバーの動作ログを確認したい。これにより、問題の診断とトラブルシューティングが可能になる。

#### 受入基準

1. WHEN サーバーが動作する THEN 設定されたログレベルに応じてログを記録する SHALL
2. WHEN ログを記録する THEN 以下の情報を含む SHALL:
   - タイムスタンプ
   - ログレベル（DEBUG, INFO, WARN, ERROR）
   - メッセージ内容
3. WHEN エラーが発生した THEN エラーの詳細情報（スタックトレース含む）をログに記録する SHALL
4. WHEN ログファイルが一定サイズを超えた THEN 自動的にローテーションする SHALL
5. IF ログディレクトリが存在しない THEN サーバーは自動的にディレクトリを作成する SHALL

### 要件8: ラズパイ最適化

**ユーザーストーリー:** システム管理者として、ラズパイの限られたリソースで効率的にサーバーを動作させたい。これにより、安定した長時間運用が可能になる。

#### 受入基準

1. WHEN サーバーが動作する THEN メモリ使用量を512MB以下に抑える SHALL
2. WHEN 画像処理を行う THEN CPU使用率を50%以下に抑える SHALL
3. WHEN データを送信する THEN 不要なデータのコピーを避け、効率的にメモリを使用する SHALL
4. IF メモリ使用量が閾値を超えた THEN ガベージコレクションを実行し、警告ログを記録する SHALL
5. WHEN サーバーが長時間動作する THEN メモリリークが発生しない SHALL

### 要件9: エラーハンドリングと回復

**ユーザーストーリー:** システム管理者として、エラー発生時にサーバーが自動的に回復することを期待する。これにより、手動介入なしで安定した運用が可能になる。

#### 受入基準

1. WHEN WebSocket送信エラーが発生した THEN サーバーは該当クライアントの接続を切断する SHALL
2. WHEN 外部プログラムが予期せず切断した THEN サーバーはElectronクライアントに通知を送信する SHALL
3. WHEN データ転送エラーが発生した THEN サーバーはエラーログを記録し、エラー通知を送信する SHALL
4. WHEN 予期しないエラーが発生した THEN サーバーはクラッシュせず、エラーログを記録して動作を継続する SHALL
5. IF 致命的なエラーが発生した THEN サーバーは適切にシャットダウンし、終了コード1を返す SHALL
6. WHEN 接続タイムアウトが発生した THEN サーバーは該当クライアントの接続を切断し、ログに記録する SHALL

### 要件10: 起動・停止管理

**ユーザーストーリー:** システム管理者として、サーバーを簡単に起動・停止したい。また、システム起動時に自動的にサーバーが起動することを期待する。

#### 受入基準

1. WHEN `npm start`コマンドを実行した THEN サーバーが起動する SHALL
2. WHEN サーバーが起動した THEN 起動完了メッセージとアクセスURLをログに出力する SHALL
3. WHEN SIGTERM または SIGINT シグナルを受信した THEN サーバーは優雅にシャットダウンする SHALL
4. WHEN シャットダウンする THEN 全ての接続を適切にクローズし、リソースを解放する SHALL
5. IF systemdサービスとして設定された THEN システム起動時に自動的にサーバーが起動する SHALL
